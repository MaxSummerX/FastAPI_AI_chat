<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI AI –ß–∞—Ç - –†–∞–∑–¥–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å Refresh Token</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --success-color: #16a34a;
            --error-color: #dc2626;
            --warning-color: #f59e0b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --radius-sm: 4px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .left-panel {
            width: 400px;
            min-width: 350px;
            max-width: 500px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 16px;
            text-align: center;
            flex-shrink: 0;
        }

        .panel-header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .panel-header .subtitle {
            margin-top: 4px;
            opacity: 0.9;
            font-size: 12px;
        }

        .panel-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —á–∞—Ç–∞ */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .chat-header {
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chat-status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-input-container {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        /* –°—Ç–∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ */
        .control-section {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }

        .control-section h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 13px;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 13px;
            transition: all 0.2s;
            background: var(--bg-primary);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .control-row {
            display: flex;
            gap: 8px;
            align-items: end;
            margin-bottom: 8px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-input {
            flex: 1;
        }

        .message {
            padding: 12px 16px;
            border-radius: var(--radius);
            max-width: 80%;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            margin-left: auto;
            text-align: right;
            border: 1px solid #86efac;
        }

        .message-assistant {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            margin-right: auto;
            border: 1px solid #93c5fd;
        }

        .message-content {
            margin: 0;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .status {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .status-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .status-info {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        .loading-small {
            width: 10px;
            height: 10px;
            border-top-color: var(--primary-color);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            font-style: italic;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .switch {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--primary-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: var(--shadow-sm);
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        .feature-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--primary-color);
            color: white;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 6px;
        }

        .prompt-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .char-counter {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 4px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .prompt-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-secondary);
        }

        .prompt-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .prompt-item:last-child {
            border-bottom: none;
        }

        .prompt-info {
            flex: 1;
        }

        .prompt-title {
            font-weight: 500;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .prompt-preview {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .prompt-meta {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .prompt-buttons {
            display: flex;
            gap: 4px;
        }

        /* Login —Å–µ–∫—Ü–∏—è */
        .login-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-container {
            background: var(--bg-primary);
            padding: 32px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è refresh token */
        .token-info {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-top: 8px;
            font-size: 11px;
        }

        .token-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .token-expires {
            color: var(--text-secondary);
        }

        .token-expires.warning {
            color: var(--warning-color);
        }

        .token-expires.error {
            color: var(--error-color);
        }

        .refresh-indicator {
            display: inline-block;
            padding: 2px 6px;
            background: var(--success-color);
            color: white;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 500;
            margin-left: 4px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .left-panel {
                width: 300px;
                min-width: 280px;
            }
        }

        @media (max-width: 600px) {
            .app-container {
                flex-direction: column;
            }

            .left-panel {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .right-panel {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <div class="login-container">
            <h2 style="text-align: center; margin-top: 0; color: var(--text-primary);">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <div id="loginStatus"></div>

            <div style="margin-bottom: 16px;">
                <div class="form-group">
                    <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ Email:</label>
                    <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ email">
                </div>

                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" id="rememberMe" style="width: auto;">
                        –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å refresh token)
                    </label>
                </div>

                <button id="loginBtn" class="btn-primary" style="width: 100%;">
                    <span>–í–æ–π—Ç–∏</span>
                </button>
            </div>

            <div style="border-top: 1px solid var(--border-color); padding-top: 16px;">
                <div class="form-group">
                    <label for="tokenInput">–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ JWT —Ç–æ–∫–µ–Ω:</label>
                    <textarea id="tokenInput" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à JWT —Ç–æ–∫–µ–Ω –∑–¥–µ—Å—å..."></textarea>
                </div>

                <button id="useTokenBtn" class="btn-secondary" style="width: 100%;">
                    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω
                </button>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="appContainer" class="app-container hidden">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="left-panel">
            <div class="panel-header">
                <h1>ü§ñ FastAPI AI –ß–∞—Ç</h1>
                <div class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>

            <div class="panel-content">
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ -->
                <div class="control-section">
                    <h3>üí¨ –ß–∞—Ç—ã</h3>

                    <div class="control-row">
                        <div class="control-input">
                            <input type="text" id="newChatTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞">
                        </div>
                        <button id="createChatBtn" class="btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>

                    <div class="control-row">
                        <div class="control-input">
                            <select id="selectedChat">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç...</option>
                            </select>
                        </div>
                        <button id="refreshChatsBtn" class="btn-secondary btn-small">üîÑ</button>
                    </div>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞–º–∏ -->
                <div class="control-section">
                    <h3>üìù –ü—Ä–æ–º–ø—Ç—ã <span class="feature-badge">PROMPTS</span></h3>

                    <div class="control-row">
                        <div class="control-input">
                            <select id="promptSelect">
                                <option value="">–ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç</option>
                            </select>
                        </div>
                        <button id="managePromptsBtn" class="btn-secondary btn-small">üìù</button>
                    </div>

                    <div class="control-row">
                        <button id="createPromptBtn" class="btn-success" style="width: 100%;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç</button>
                    </div>

                    <div class="prompt-info">–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–º—è—Ç–∏ -->
                <div class="control-section">
                    <h3>üß† –ü–∞–º—è—Ç—å (mem0ai)</h3>

                    <div class="switch">
                        <div id="mem0aiToggle" class="toggle-switch" onclick="toggleMem0ai()"></div>
                        <span id="mem0aiStatus">–í—ã–∫–ª—é—á–µ–Ω–æ</span>
                    </div>

                    <div class="prompt-info">–í–∫–ª—é—á–∏—Ç–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –æ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö</div>
                </div>

                <!-- –¢–æ–∫–µ–Ω —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ refresh -->
                <div class="control-section">
                    <h3>üîë –¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω</h3>
                    <div style="font-size: 10px; color: var(--text-secondary); font-family: monospace; word-break: break-all; padding: 8px; background: var(--bg-tertiary); border-radius: var(--radius-sm);" id="currentTokenDisplay">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>

                    <div class="token-info" id="tokenInfo" style="display: none;">
                        <div class="token-status">
                            <span>–°—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞:</span>
                            <span id="tokenStatusText">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        </div>
                        <div class="token-expires" id="tokenExpires">
                            –ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑: --
                        </div>
                        <div id="refreshIndicator" class="refresh-indicator hidden">
                            üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...
                        </div>
                    </div>

                    <div style="margin-top: 8px;">
                        <button id="logoutBtn" class="btn-danger btn-small" style="width: 100%;">
                            üö™ –í—ã–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —á–∞—Ç–∞ -->
        <div class="right-panel">
            <div class="chat-header">
                <h2 id="chatTitle">üí¨ –ß–∞—Ç</h2>
                <div class="chat-status" id="chatStatus"></div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message message-assistant">
                    <div class="message-content">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è.</div>
                    <div class="message-time">–°–∏—Å—Ç–µ–º–∞</div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="form-group">
                    <label for="messageInput">–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <textarea id="messageInput" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–¥–µ—Å—å..." maxlength="4000"></textarea>
                    <div class="char-counter">
                        <span id="charCount">0</span>/4000
                    </div>
                </div>
                <button id="sendBtn" class="btn-primary" disabled style="width: 100%;">
                    <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞–º–∏ -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç</h3>
                <button class="close-btn" onclick="closePromptModal()">‚úï</button>
            </div>

            <div id="modalStatus"></div>

            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ -->
            <div id="promptForm">
                <div class="form-group">
                    <label for="promptTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞:</label>
                    <input type="text" id="promptTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞" maxlength="100">
                </div>

                <div class="form-group">
                    <label for="promptContent">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–º–ø—Ç–∞:</label>
                    <textarea id="promptContent" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞..." maxlength="2000"></textarea>
                </div>

                <div class="form-group">
                    <label for="promptMetadata">–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <textarea id="promptMetadata" rows="3" placeholder='{"–∫–ª—é—á": "–∑–Ω–∞—á–µ–Ω–∏–µ"}'></textarea>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button id="cancelPromptBtn" class="btn-secondary" onclick="closePromptModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button id="savePromptBtn" class="btn-primary">
                        <span>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç</span>
                    </button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ -->
            <div id="promptListSection" class="hidden">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <button id="backToFormBtn" class="btn-secondary" onclick="openCreatePromptModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç</button>
                    <button id="refreshPromptsBtn" class="btn-secondary btn-small">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>

                <div id="promptsListContainer">
                    <div class="prompt-info">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_BASE = window.location.origin;

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        let authToken = null;
        let refreshToken = null;
        let tokenExpiry = null;
        let refreshTimer = null;
        let isRefreshing = false;
        let refreshPromise = null;
        let chats = [];
        let prompts = [];
        let currentChatId = null;
        let mem0aiEnabled = false;
        let editingPromptId = null;

        // DOM –≠–ª–µ–º–µ–Ω—Ç—ã
        const loginSection = document.getElementById('loginSection');
        const appContainer = document.getElementById('appContainer');
        const loginStatus = document.getElementById('loginStatus');
        const chatStatus = document.getElementById('chatStatus');
        const chatTitle = document.getElementById('chatTitle');
        const chatMessages = document.getElementById('chatMessages');
        const selectedChat = document.getElementById('selectedChat');
        const promptSelect = document.getElementById('promptSelect');
        const currentTokenDisplay = document.getElementById('currentTokenDisplay');
        const tokenInfo = document.getElementById('tokenInfo');
        const tokenStatusText = document.getElementById('tokenStatusText');
        const tokenExpires = document.getElementById('tokenExpires');
        const refreshIndicator = document.getElementById('refreshIndicator');
        const messageInput = document.getElementById('messageInput');
        const charCount = document.getElementById('charCount');

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–º–ø—Ç–æ–≤
        const promptModal = document.getElementById('promptModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalStatus = document.getElementById('modalStatus');
        const promptForm = document.getElementById('promptForm');
        const promptListSection = document.getElementById('promptListSection');
        const promptsListContainer = document.getElementById('promptsListContainer');

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('useTokenBtn').addEventListener('click', useToken);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('createChatBtn').addEventListener('click', createChat);
        document.getElementById('refreshChatsBtn').addEventListener('click', loadChats);
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('createPromptBtn').addEventListener('click', openCreatePromptModal);
        document.getElementById('managePromptsBtn').addEventListener('click', openManagePromptsModal);
        document.getElementById('savePromptBtn').addEventListener('click', savePrompt);
        document.getElementById('refreshPromptsBtn').addEventListener('click', loadAndDisplayPrompts);

        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        messageInput.addEventListener('input', function() {
            charCount.textContent = this.value.length;
            updateSendButtonState();
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        function updateSendButtonState() {
            const sendBtn = document.getElementById('sendBtn');
            const hasMessage = messageInput.value.trim().length > 0;
            const hasChat = currentChatId !== null;
            sendBtn.disabled = !hasMessage || !hasChat;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞
        selectedChat.addEventListener('change', async function() {
            currentChatId = this.value;
            updateSendButtonState();

            if (currentChatId) {
                const selectedOption = this.options[this.selectedIndex];
                chatTitle.textContent = `üí¨ ${selectedOption.textContent}`;
                await loadChatHistory(currentChatId);
                await loadPrompts();
            } else {
                chatTitle.textContent = 'üí¨ –ß–∞—Ç';
                chatMessages.innerHTML = `
                    <div class="message message-assistant">
                        <div class="message-content">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è.</div>
                        <div class="message-time">–°–∏—Å—Ç–µ–º–∞</div>
                    </div>
                `;
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å mem0ai
        function toggleMem0ai() {
            mem0aiEnabled = !mem0aiEnabled;
            const toggle = document.getElementById('mem0aiToggle');
            const status = document.getElementById('mem0aiStatus');

            if (mem0aiEnabled) {
                toggle.classList.add('active');
                status.textContent = '–í–∫–ª—é—á–µ–Ω–æ';
            } else {
                toggle.classList.remove('active');
                status.textContent = '–í—ã–∫–ª—é—á–µ–Ω–æ';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JWT —Ç–æ–∫–µ–Ω–∞
        function parseJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JWT:', e);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–∫–µ–Ω–µ
        function updateTokenInfo() {
            if (!authToken) {
                tokenInfo.style.display = 'none';
                return;
            }

            const payload = parseJWT(authToken);
            if (!payload || !payload.exp) {
                tokenInfo.style.display = 'none';
                return;
            }

            tokenInfo.style.display = 'block';
            tokenExpiry = payload.exp * 1000; // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã

            updateTokenExpiryDisplay();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        function updateTokenExpiryDisplay() {
            if (!tokenExpiry) return;

            const now = Date.now();
            const timeLeft = tokenExpiry - now;

            if (timeLeft <= 0) {
                tokenStatusText.textContent = '–ò—Å—Ç—ë–∫';
                tokenStatusText.style.color = 'var(--error-color)';
                tokenExpires.textContent = '–¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫';
                tokenExpires.className = 'token-expires error';
                return;
            }

            const minutes = Math.floor(timeLeft / (1000 * 60));
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            let timeLeftText = '';
            let className = 'token-expires';

            if (days > 0) {
                timeLeftText = `${days}–¥ ${hours % 24}—á`;
                className = 'token-expires';
            } else if (hours > 0) {
                timeLeftText = `${hours}—á ${minutes % 60}–º`;
                className = 'token-expires';
            } else if (minutes > 5) {
                timeLeftText = `${minutes}–º`;
                className = 'token-expires';
            } else {
                timeLeftText = `${minutes}–º ${Math.floor((timeLeft % 60000) / 1000)}—Å`;
                className = 'token-expires warning';
                tokenStatusText.textContent = '–°–∫–æ—Ä–æ –∏—Å—Ç–µ—á—ë—Ç';
                tokenStatusText.style.color = 'var(--warning-color)';
            }

            tokenExpires.textContent = `–ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑: ${timeLeftText}`;
            tokenExpires.className = className;
        }

        // –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        function setupRefreshTimer() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }

            if (!refreshToken || !tokenExpiry) {
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
            const refreshTime = tokenExpiry - Date.now() - (5 * 60 * 1000);

            if (refreshTime > 0) {
                refreshTimer = setTimeout(async () => {
                    await refreshAccessToken();
                }, refreshTime);
            } else {
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á—ë—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É
                refreshAccessToken();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(updateTokenExpiryDisplay, 60000);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access —Ç–æ–∫–µ–Ω–∞
        async function refreshAccessToken() {
            if (isRefreshing || !refreshToken) {
                return;
            }

            isRefreshing = true;
            refreshIndicator.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE}/api/v1/user/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const newToken = data.access_token || data.token;

                    if (newToken) {
                        authToken = newToken;
                        currentTokenDisplay.textContent = newToken.substring(0, 30) + '...';
                        updateTokenInfo();
                        setupRefreshTimer();

                        console.log('–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω');
                    } else {
                        throw new Error('–ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
                showStatus(chatStatus, `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω: ${error.message}`, 'warning');

                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
                if (error.message.includes('401') || error.message.includes('Invalid')) {
                    logout();
                    showStatus(loginStatus, '‚ö†Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'warning');
                }
            } finally {
                isRefreshing = false;
                refreshIndicator.classList.add('hidden');
            }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
        async function makeAuthenticatedRequest(url, options = {}) {
            if (!authToken) {
                throw new Error('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ —Ç–æ–∫–µ–Ω
            const payload = parseJWT(authToken);
            if (payload && payload.exp && payload.exp * 1000 < Date.now()) {
                if (refreshToken && !isRefreshing) {
                    await refreshAccessToken();
                } else {
                    throw new Error('–¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω');
                }
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            };

            const response = await fetch(url, { ...options, ...defaultOptions });

            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ–º 401, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
            if (response.status === 401 && refreshToken && !isRefreshing) {
                await refreshAccessToken();

                // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
                defaultOptions.headers.Authorization = `Bearer ${authToken}`;
                return await fetch(url, { ...options, ...defaultOptions });
            }

            return response;
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!username || !password) {
                showStatus(loginStatus, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }

            const loginBtn = document.getElementById('loginBtn');
            const originalContent = loginBtn.innerHTML;
            loginBtn.innerHTML = '<span class="loading"></span> –í—Ö–æ–¥...';
            loginBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/v1/user/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
                });

                if (response.ok) {
                    const data = await response.json();
                    const token = data.access_token || data.token;

                    if (token) {
                        authToken = token;

                        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è" –∏ –µ—Å—Ç—å refresh token
                        if (rememberMe && data.refresh_token) {
                            refreshToken = data.refresh_token;
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º refresh token –≤ localStorage
                            localStorage.setItem('refreshToken', refreshToken);
                        }

                        currentTokenDisplay.textContent = token.substring(0, 30) + '...';
                        showStatus(loginStatus, '‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');

                        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–∫–µ–Ω–µ –∏ —Ç–∞–π–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        updateTokenInfo();
                        if (refreshToken) {
                            setupRefreshTimer();
                        }

                        setTimeout(() => {
                            loginSection.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            loadChats();
                        }, 1000);
                    } else {
                        throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç API');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                showStatus(loginStatus, `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`, 'error');
            } finally {
                loginBtn.innerHTML = originalContent;
                loginBtn.disabled = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        async function logout() {
            try {
                if (refreshToken) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–∑—ã–≤ refresh —Ç–æ–∫–µ–Ω–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç)
                    try {
                        await fetch(`${API_BASE}/api/v1/user/logout`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                refresh_token: refreshToken
                            })
                        });
                    } catch (e) {
                        console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ refresh —Ç–æ–∫–µ–Ω–∞:', e);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
            } finally {
                // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –∏ —Ç–∞–π–º–µ—Ä—ã
                authToken = null;
                refreshToken = null;
                tokenExpiry = null;

                if (refreshTimer) {
                    clearTimeout(refreshTimer);
                    refreshTimer = null;
                }

                localStorage.removeItem('refreshToken');

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
                currentTokenDisplay.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                tokenInfo.style.display = 'none';
                loginSection.classList.remove('hidden');
                appContainer.classList.add('hidden');

                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('rememberMe').checked = false;
            }
        }

        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω
        function useToken() {
            const token = document.getElementById('tokenInput').value.trim();

            if (!token) {
                showStatus(loginStatus, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω', 'error');
                return;
            }

            authToken = token;
            currentTokenDisplay.textContent = token.substring(0, 30) + '...';
            showStatus(loginStatus, '‚úÖ –¢–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞
            const savedRefreshToken = localStorage.getItem('refreshToken');
            if (savedRefreshToken) {
                refreshToken = savedRefreshToken;
                updateTokenInfo();
                setupRefreshTimer();
            } else {
                updateTokenInfo();
            }

            setTimeout(() => {
                loginSection.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadChats();
            }, 1000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞
            const savedRefreshToken = localStorage.getItem('refreshToken');
            if (savedRefreshToken) {
                refreshToken = savedRefreshToken;
                console.log('–ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π refresh token');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadPrompts() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/v1/prompts/`);

                if (response.ok) {
                    const responseData = await response.json();
                    prompts = responseData.prompts || [];
                    promptSelect.innerHTML = '<option value="">–ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç</option>';

                    prompts.forEach(prompt => {
                        const option = document.createElement('option');
                        option.value = prompt.id;
                        option.textContent = prompt.title || `–ü—Ä–æ–º–ø—Ç ${prompt.id}`;
                        promptSelect.appendChild(option);
                    });

                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${prompts.length} –ø—Ä–æ–º–ø—Ç–æ–≤`);
                } else {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤: ${response.status}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤:', error);
                showStatus(chatStatus, `‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã: ${error.message}`, 'warning');
            }
        }

        // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç
        async function createChat() {
            const title = document.getElementById('newChatTitle').value.trim();

            if (!title) {
                showStatus(chatStatus, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞', 'error');
                return;
            }

            const createBtn = document.getElementById('createChatBtn');
            const originalContent = createBtn.innerHTML;
            createBtn.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';
            createBtn.disabled = true;

            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/v1/conversations/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showStatus(chatStatus, '‚úÖ –ß–∞—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    document.getElementById('newChatTitle').value = '';

                    await loadChats();

                    if (data.id) {
                        selectedChat.value = data.id;
                        currentChatId = data.id;
                        chatTitle.textContent = `üí¨ ${title}`;

                        await loadChatHistory(currentChatId);
                        await loadPrompts();

                        updateSendButtonState();
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
                showStatus(chatStatus, `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç: ${error.message}`, 'error');
            } finally {
                createBtn.innerHTML = originalContent;
                createBtn.disabled = false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
        async function loadChats() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/v1/conversations/`);

                if (response.ok) {
                    chats = await response.json();

                    selectedChat.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç...</option>';
                    chats.forEach(chat => {
                        const option = document.createElement('option');
                        option.value = chat.id;
                        option.textContent = chat.title || `–ß–∞—Ç ${chat.id}`;
                        selectedChat.appendChild(option);
                    });

                    showStatus(chatStatus, '‚úÖ –ß–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                showStatus(chatStatus, `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã: ${error.message}`, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
        async function loadChatHistory(chatId) {
            try {
                chatMessages.innerHTML = `
                    <div class="message message-assistant">
                        <div class="message-content">üìú –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
                        <div class="message-time">–°–∏—Å—Ç–µ–º–∞</div>
                    </div>
                `;

                const response = await makeAuthenticatedRequest(`${API_BASE}/api/v1/conversations/${chatId}/messages/`);

                if (response.ok) {
                    const messages = await response.json();
                    chatMessages.innerHTML = '';

                    if (messages.length > 0) {
                        messages.forEach(message => {
                            addMessage(message.role, message.content, false, message.timestamp);
                        });
                    } else {
                        addMessage('assistant', 'üÜï –≠—Ç–æ—Ç —á–∞—Ç –ø—É—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ.', false);
                    }

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    showStatus(chatStatus, '‚úÖ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:', error);
                addMessage('assistant', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}`, false);
                showStatus(chatStatus, `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é: ${error.message}`, 'error');
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        async function sendMessage() {
            const message = messageInput.value.trim();

            if (!message) {
                showStatus(chatStatus, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
                return;
            }

            if (!currentChatId) {
                showStatus(chatStatus, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç', 'error');
                return;
            }

            addMessage('user', message);
            messageInput.value = '';
            charCount.textContent = '0';
            document.getElementById('sendBtn').disabled = true;

            try {
                const typingIndicator = addTypingIndicator();
                const streamUrl = `${API_BASE}/api/v1/conversations/${currentChatId}/messages/stream_v2`;

                const params = new URLSearchParams();
                if (mem0aiEnabled) {
                    params.append('mem0ai_on', 'true');
                }
                if (promptSelect.value) {
                    params.append('prompt_id', promptSelect.value);
                }

                const response = await makeAuthenticatedRequest(`${streamUrl}?${params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: message,
                        role: 'user'
                    })
                });

                if (!response.ok) {
                    removeTypingIndicator(typingIndicator);
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                if (!response.body) {
                    throw new Error('ReadableStream –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMessage = '';

                removeTypingIndicator(typingIndicator);
                const messageElement = addMessage('assistant', '', false);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });

                    if (chunk.startsWith('data: ')) {
                        const data = chunk.slice(6).trim();
                        if (data === '[DONE]') break;

                        try {
                            const parsed = JSON.parse(data);

                            if (parsed.content !== undefined) {
                                assistantMessage += parsed.content;
                            } else if (parsed.choices && parsed.choices[0]) {
                                const choice = parsed.choices[0];
                                if (choice.delta && choice.delta.content) {
                                    assistantMessage += choice.delta.content;
                                } else if (choice.text) {
                                    assistantMessage += choice.text;
                                }
                            }

                            messageElement.querySelector('.message-content').textContent = assistantMessage;
                        } catch (e) {
                            assistantMessage += data;
                            messageElement.querySelector('.message-content').textContent = assistantMessage;
                        }
                    } else {
                        assistantMessage += chunk;
                        messageElement.querySelector('.message-content').textContent = assistantMessage;
                    }

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                reader.releaseLock();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);

                const typingIndicators = document.querySelectorAll('.typing-indicator');
                typingIndicators.forEach(indicator => indicator.remove());

                addMessage('assistant', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                showStatus(chatStatus, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            } finally {
                updateSendButtonState();
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞–º–∏
        function openCreatePromptModal() {
            editingPromptId = null;
            modalTitle.textContent = 'üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç';
            document.getElementById('promptTitle').value = '';
            document.getElementById('promptContent').value = '';
            document.getElementById('promptMetadata').value = '';
            modalStatus.innerHTML = '';
            showPromptForm();
            promptModal.classList.add('active');
        }

        function openManagePromptsModal() {
            editingPromptId = null;
            modalTitle.textContent = 'üìã –ú–æ–∏ –ø—Ä–æ–º–ø—Ç—ã';
            modalStatus.innerHTML = '';
            promptModal.classList.add('active');
            showPromptList();
            loadAndDisplayPrompts();
        }

        function closePromptModal() {
            promptModal.classList.remove('active');
            editingPromptId = null;
        }

        function showPromptForm() {
            promptForm.classList.remove('hidden');
            promptListSection.classList.add('hidden');
        }

        function showPromptList() {
            promptForm.classList.add('hidden');
            promptListSection.classList.remove('hidden');
        }

        async function loadAndDisplayPrompts() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/v1/prompts/`);

                if (response.ok) {
                    const data = await response.json();
                    const allPrompts = data.prompts || [];

                    if (allPrompts.length === 0) {
                        promptsListContainer.innerHTML = `
                            <div class="prompt-info">
                                <div class="status status-info">
                                    –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–ø—Ç!
                                </div>
                            </div>
                        `;
                        return;
                    }

                    promptsListContainer.innerHTML = `
                        <div class="prompt-list">
                            ${allPrompts.map(prompt => `
                                <div class="prompt-item" data-prompt-id="${prompt.id}">
                                    <div class="prompt-info">
                                        <div class="prompt-title">${prompt.title || `–ü—Ä–æ–º–ø—Ç ${prompt.id}`}</div>
                                        <div class="prompt-preview">${prompt.content || '–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ'}</div>
                                        <div class="prompt-meta">
                                            –°–æ–∑–¥–∞–Ω: ${new Date(prompt.created_at).toLocaleDateString('ru-RU')}
                                            ${prompt.updated_at ? '| –û–±–Ω–æ–≤–ª–µ–Ω: ' + new Date(prompt.updated_at).toLocaleDateString('ru-RU') : ''}
                                        </div>
                                    </div>
                                    <div class="prompt-buttons">
                                        <button class="btn-primary btn-small" onclick="editPrompt('${prompt.id}')">‚úèÔ∏è</button>
                                        <button class="btn-danger btn-small" onclick="deletePrompt('${prompt.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ${allPrompts.length} –ø—Ä–æ–º–ø—Ç–æ–≤`);
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤:', error);
                promptsListContainer.innerHTML = `
                    <div class="status status-error">
                        ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã: ${error.message}
                    </div>
                `;
            }
        }

        async function savePrompt() {
            const title = document.getElementById('promptTitle').value.trim();
            const content = document.getElementById('promptContent').value.trim();
            let metadata = null;

            if (!title) {
                showStatus(modalStatus, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞', 'error');
                return;
            }

            if (!content) {
                showStatus(modalStatus, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–º–ø—Ç–∞', 'error');
                return;
            }

            const metadataText = document.getElementById('promptMetadata').value.trim();
            if (metadataText) {
                try {
                    metadata = JSON.parse(metadataText);
                } catch (e) {
                    showStatus(modalStatus, '–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö', 'error');
                    return;
                }
            }

            const saveBtn = document.getElementById('savePromptBtn');
            const originalContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="loading loading-small"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            saveBtn.disabled = true;

            try {
                const url = editingPromptId
                    ? `${API_BASE}/api/v1/prompts/${editingPromptId}`
                    : `${API_BASE}/api/v1/prompts/`;

                const method = editingPromptId ? 'PUT' : 'POST';

                const response = await makeAuthenticatedRequest(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        metadata_: metadata
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const action = editingPromptId ? '–æ–±–Ω–æ–≤–ª–µ–Ω' : '—Å–æ–∑–¥–∞–Ω';
                    showStatus(modalStatus, `‚úÖ –ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ ${action}!`, 'success');

                    if (editingPromptId) {
                        editingPromptId = null;
                    }

                    setTimeout(() => {
                        closePromptModal();
                        loadPrompts();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞:', error);
                showStatus(modalStatus, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            } finally {
                saveBtn.innerHTML = originalContent;
                saveBtn.disabled = false;
            }
        }

        function editPrompt(promptId) {
            const prompt = prompts.find(p => p.id === promptId);
            if (!prompt) {
                showStatus(modalStatus, '–ü—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            editingPromptId = promptId;
            modalTitle.textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç';
            document.getElementById('promptTitle').value = prompt.title || '';
            document.getElementById('promptContent').value = prompt.content || '';
            document.getElementById('promptMetadata').value = prompt.metadata_ ? JSON.stringify(prompt.metadata_, null, 2) : '';
            modalStatus.innerHTML = '';
            showPromptForm();
        }

        async function deletePrompt(promptId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç?')) {
                return;
            }

            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/v1/prompts/${promptId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showStatus(modalStatus, '‚úÖ –ü—Ä–æ–º–ø—Ç —É–¥–∞–ª–µ–Ω!', 'success');
                    loadAndDisplayPrompts();
                    loadPrompts();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–ø—Ç');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞:', error);
                showStatus(modalStatus, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        function addMessage(sender, content, scrollToBottom = true, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            const isUser = sender === 'user';
            messageDiv.classList.add(isUser ? 'message-user' : 'message-assistant');

            const time = timestamp ? new Date(timestamp).toLocaleTimeString('ru-RU') :
                         isUser ? '–í—ã' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç';

            messageDiv.innerHTML = `
                <div class="message-content">${formatMessageContent(content)}</div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);

            if (scrollToBottom) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            return messageDiv;
        }

        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'message-assistant');
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return typingDiv;
        }

        function removeTypingIndicator(element) {
            if (element && element.parentNode) {
                element.parentNode.removeChild(element);
            }
        }

        function formatMessageContent(content) {
            if (!content) return '';
            return content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
        }

        function showStatus(element, message, type = 'info') {
            element.innerHTML = `
                <div class="status status-${type}">
                    ${message}
                </div>
            `;

            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        }

        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!document.getElementById('sendBtn').disabled) {
                    sendMessage();
                }
            }
        });

        window.onclick = function(event) {
            if (event.target === promptModal) {
                closePromptModal();
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        window.addEventListener('beforeunload', function() {
            if (refreshTimer) {
                clearTimeout(refreshTimer);
            }
        });
    </script>
</body>
</html>
