<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Page</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.6/purify.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        #app {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .auth-status {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 10px;
        }

        .container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #2d3748;
        }

        .tab-btn:hover {
            background: #cbd5e0;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a5568;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 55, 72, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #718096;
            color: white;
        }

        .btn-danger:hover {
            background: #4a5568;
        }

        .response-box {
            margin-top: 20px;
            padding: 20px;
            background: #edf2f7;
            border-radius: 8px;
            border-left: 4px solid #4a5568;
        }

        .response-box h3 {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .response-box pre {
            background: #2d3748;
            color: #a0aec0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }

        .error {
            background: #e2e8f0;
            border-left-color: #718096;
        }

        .error pre {
            color: #718096;
        }

        .conversations-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .conversation-item {
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .conversation-item:hover {
            background: #cbd5e0;
            transform: translateX(5px);
        }

        .conversation-item.selected {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
        }

        .messages-list {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
        }

        .message-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            position: relative;
        }

        .message-item.user {
            background: #4a5568;
            color: white;
            margin-left: 20%;
        }

        .message-item.assistant {
            background: #cbd5e0;
            color: #2d3748;
            margin-right: 20%;
        }

        .message-item.system {
            background: #e2e8f0;
            color: #4a5568;
        }

        .message-content {
            line-height: 1.5;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin: 0.5em 0;
        }

        .message-content p {
            margin: 0.5em 0;
        }

        .message-content pre {
            background: #2d3748;
            color: #a0aec0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .message-content code {
            background: #2d3748;
            color: #a0aec0;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .message-content blockquote {
            border-left: 3px solid #4a5568;
            padding-left: 10px;
            margin: 0.5em 0;
            color: #718096;
        }

        .message-content ul,
        .message-content ol {
            padding-left: 20px;
            margin: 0.5em 0;
        }

        .message-content li {
            margin: 0.2em 0;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5em 0;
        }

        .message-content th,
        .message-content td {
            border: 1px solid #4a5568;
            padding: 8px;
            text-align: left;


        .message-content th {
            background: #4a5568;
            color: white;
        }

        .message-role {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
            border-left: 4px solid #4a5568;
        }

        .info-card h4 {
            margin-bottom: 8px;
            color: #2d3748;
        }

        .info-card p {
            color: #718096;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>API Test Page</h1>
            <div class="auth-status">
                <span v-if="isAuthenticated">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: {{ userEmail }}</span>
                <span v-else>‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
            </div>
        </div>

        <div class="container">
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º -->
            <div class="tabs">
                <button class="tab-btn" :class="{ active: activeTab === 'auth' }" @click="activeTab = 'auth'">
                    üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                </button>
                <button class="tab-btn" :class="{ active: activeTab === 'user' }" @click="activeTab = 'user'">
                    üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                </button>
                <button class="tab-btn" :class="{ active: activeTab === 'conversations' }" @click="activeTab = 'conversations'">
                    üí¨ –ë–µ—Å–µ–¥—ã
                </button>
                <button class="tab-btn" :class="{ active: activeTab === 'messages' }" @click="activeTab = 'messages'">
                    üì® –°–æ–æ–±—â–µ–Ω–∏—è
                </button>
                <button class="tab-btn" :class="{ active: activeTab === 'polygon' }" @click="activeTab = 'polygon'">
                    üß™ Polygon
                </button>
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
            <div class="section" :class="{ active: activeTab === 'auth' }">
                <h2>üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <div class="form-group">
                    <label>Username</label>
                    <input v-model="registerData.username" placeholder="username" />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input v-model="registerData.email" type="email" placeholder="email@example.com" />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input v-model="registerData.password" type="password" placeholder="–º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤" />
                </div>
                <button class="btn btn-primary" @click="registerUser">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">–í—Ö–æ–¥</h3>
                <div class="form-group">
                    <label>Username –∏–ª–∏ Email</label>
                    <input v-model="loginData.username" placeholder="username –∏–ª–∏ email" />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input v-model="loginData.password" type="password" placeholder="–ø–∞—Ä–æ–ª—å" />
                </div>
                <button class="btn btn-primary" @click="loginUser">–í–æ–π—Ç–∏</button>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">–û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω</h3>
                <button class="btn btn-secondary" @click="refreshToken" :disabled="!refreshTokenValue">
                    –û–±–Ω–æ–≤–∏—Ç—å Access Token
                </button>
                <button class="btn btn-danger" @click="logout">–í—ã–π—Ç–∏</button>

                <div v-if="response" class="response-box" :class="{ error: response.error }">
                    <h3>{{ response.error ? '‚ùå –û—à–∏–±–∫–∞' : '‚úÖ –û—Ç–≤–µ—Ç' }}</h3>
                    <pre>{{ JSON.stringify(response, null, 2) }}</pre>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
            <div class="section" :class="{ active: activeTab === 'user' }">
                <h2>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h2>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" @click="getUserBase">–ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
                    <button class="btn btn-primary" @click="getUserFull">–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
                </div>

                <div v-if="userInfo" class="grid">
                    <div class="info-card">
                        <h4>ID</h4>
                        <p>{{ userInfo.id }}</p>
                    </div>
                    <div class="info-card">
                        <h4>Username</h4>
                        <p>{{ userInfo.username }}</p>
                    </div>
                    <div class="info-card">
                        <h4>Email</h4>
                        <p>{{ userInfo.email }}</p>
                    </div>
                    <div class="info-card">
                        <h4>–ê–∫—Ç–∏–≤–µ–Ω</h4>
                        <p>{{ userInfo.is_active ? '–î–∞' : '–ù–µ—Ç' }}</p>
                    </div>
                    <div class="info-card" v-if="userInfo.first_name">
                        <h4>–ò–º—è</h4>
                        <p>{{ userInfo.first_name }}</p>
                    </div>
                    <div class="info-card" v-if="userInfo.last_name">
                        <h4>–§–∞–º–∏–ª–∏—è</h4>
                        <p>{{ userInfo.last_name }}</p>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                <div class="form-group">
                    <label>–ò–º—è</label>
                    <input v-model="updateProfile.first_name" placeholder="–ò–º—è" />
                </div>
                <div class="form-group">
                    <label>–§–∞–º–∏–ª–∏—è</label>
                    <input v-model="updateProfile.last_name" placeholder="–§–∞–º–∏–ª–∏—è" />
                </div>
                <div class="form-group">
                    <label>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</label>
                    <textarea v-model="updateProfile.bio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."></textarea>
                </div>
                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input v-model="updateProfile.phone_number" placeholder="+7 (999) 123-45-67" />
                </div>
                <div class="form-group">
                    <label>–Ø–∑—ã–∫</label>
                    <select v-model="updateProfile.preferred_language">
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
                    <input v-model="updateProfile.timezone" placeholder="Europe/Moscow" />
                </div>
                <button class="btn btn-primary" @click="updateUserProfile">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

                <div v-if="response" class="response-box" :class="{ error: response.error }">
                    <h3>{{ response.error ? '‚ùå –û—à–∏–±–∫–∞' : '‚úÖ –û—Ç–≤–µ—Ç' }}</h3>
                    <pre>{{ JSON.stringify(response, null, 2) }}</pre>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –ë–µ—Å–µ–¥—ã -->
            <div class="section" :class="{ active: activeTab === 'conversations' }">
                <h2>üí¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ—Å–µ–¥–∞–º–∏</h2>

                <h3 style="margin-bottom: 15px;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –±–µ—Å–µ–¥—É</h3>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–µ—Å–µ–¥—ã</label>
                    <input v-model="conversationTitle" placeholder="–ú–æ—è –ø–µ—Ä–≤–∞—è –±–µ—Å–µ–¥–∞" />
                </div>
                <button class="btn btn-primary" @click="createConversation">–°–æ–∑–¥–∞—Ç—å –±–µ—Å–µ–¥—É</button>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">–°–ø–∏—Å–æ–∫ –±–µ—Å–µ–¥</h3>
                <div class="conversations-list" v-if="conversations.length > 0">
                    <div
                        v-for="conv in conversations"
                        :key="conv.id"
                        class="conversation-item"
                        :class="{ selected: selectedConversation?.id === conv.id }"
                        @click="selectConversation(conv)"
                    >
                        <strong>{{ conv.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</strong>
                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                            {{ new Date(conv.created_at).toLocaleString('ru-RU') }}
                        </div>
                    </div>
                </div>
                <p v-else style="color: #666; padding: 20px; text-align: center;">
                    –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –±–µ—Å–µ–¥. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!
                </p>

                <div v-if="response" class="response-box" :class="{ error: response.error }">
                    <h3>{{ response.error ? '‚ùå –û—à–∏–±–∫–∞' : '‚úÖ –û—Ç–≤–µ—Ç' }}</h3>
                    <pre>{{ JSON.stringify(response, null, 2) }}</pre>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="section" :class="{ active: activeTab === 'messages' }">
                <h2>üì® –°–æ–æ–±—â–µ–Ω–∏—è –≤ –±–µ—Å–µ–¥–µ</h2>

                <div v-if="selectedConversation">
                    <div class="info-card" style="margin-bottom: 20px;">
                        <h4>–í—ã–±—Ä–∞–Ω–Ω–∞—è –±–µ—Å–µ–¥–∞</h4>
                        <p><strong>{{ selectedConversation.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è' }}</strong></p>
                        <p style="font-size: 12px; opacity: 0.7;">ID: {{ selectedConversation.id }}</p>
                    </div>

                    <div class="messages-list" v-if="messages.length > 0">
                        <div
                            v-for="msg in messages"
                            :key="msg.id"
                            class="message-item"
                            :class="msg.role"
                        >
                            <div class="message-role">{{ msg.role }}</div>
                            <div class="message-content" v-html="renderMarkdown(msg.content)"></div>
                            <div class="message-time">
                                {{ new Date(msg.timestamp).toLocaleString('ru-RU') }}
                            </div>
                        </div>
                    </div>
                    <p v-else style="color: #666; padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                        –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ!
                    </p>

                    <h3 style="margin-top: 20px; margin-bottom: 15px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
                    <div class="form-group">
                        <label>–†–æ–ª—å</label>
                        <select v-model="messageData.role">
                            <option value="user">User</option>
                            <option value="assistant">Assistant</option>
                            <option value="system">System</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–°–æ–æ–±—â–µ–Ω–∏–µ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Markdown)</label>
                        <textarea v-model="messageData.content" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Markdown..."></textarea>
                    </div>
                    <button class="btn btn-primary" @click="sendMessage">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button class="btn btn-secondary" @click="loadMessages">–û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</button>
                </div>
                <div v-else class="info-card">
                    <h4>‚ÑπÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –±–µ—Å–µ–¥—É</h4>
                    <p>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ë–µ—Å–µ–¥—ã" –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±–µ—Å–µ–¥—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</p>
                </div>

                <div v-if="response" class="response-box" :class="{ error: response.error }">
                    <h3>{{ response.error ? '‚ùå –û—à–∏–±–∫–∞' : '‚úÖ –û—Ç–≤–µ—Ç' }}</h3>
                    <pre>{{ JSON.stringify(response, null, 2) }}</pre>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è: Polygon -->
            <div class="section" :class="{ active: activeTab === 'polygon' }">
                <h2>üß™ Polygon Chat</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    –¢–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–∞—Ç–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                </p>

                <div class="form-group">
                    <label>–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                    <textarea v-model="polygonMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                </div>
                <button class="btn btn-primary" @click="sendPolygonMessage">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

                <div v-if="response" class="response-box" :class="{ error: response.error }">
                    <h3>{{ response.error ? '‚ùå –û—à–∏–±–∫–∞' : '‚úÖ –û—Ç–≤–µ—Ç' }}</h3>
                    <pre>{{ JSON.stringify(response, null, 2) }}</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –ò–ó–ú–ï–ù–ò URL –Ω–∞ –∞–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ backend
                    apiBaseUrl: 'http://localhost:8000',

                    // –ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ UI
                    activeTab: 'auth',

                    // –¢–æ–∫–µ–Ω—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    accessToken: localStorage.getItem('accessToken') || null,
                    refreshTokenValue: localStorage.getItem('refreshToken') || null,
                    userEmail: localStorage.getItem('userEmail') || null,

                    // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    registerData: {
                        username: '',
                        email: '',
                        password: ''
                    },

                    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞
                    loginData: {
                        username: '',
                        password: ''
                    },

                    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    userInfo: null,

                    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                    updateProfile: {
                        first_name: '',
                        last_name: '',
                        bio: '',
                        phone_number: '',
                        preferred_language: 'ru',
                        timezone: 'Europe/Moscow'
                    },

                    // –ë–µ—Å–µ–¥—ã
                    conversationTitle: '',
                    conversations: [],
                    selectedConversation: null,

                    // –°–æ–æ–±—â–µ–Ω–∏—è
                    messageData: {
                        role: 'user',
                        content: ''
                    },
                    messages: [],

                    // Polygon
                    polygonMessage: '',

                    // –û—Ç–≤–µ—Ç –æ—Ç API (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
                    response: null
                };
            },

            computed: {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                isAuthenticated() {
                    return !!this.accessToken;
                }
            },

            methods: {
                /**
                 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
                 * @param {string} endpoint - –ø—É—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '/user/register')
                 * @param {Object} options - –æ–ø—Ü–∏–∏ fetch (method, body, headers)
                 * @param {boolean} requireAuth - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                 */
                async apiRequest(endpoint, options = {}, requireAuth = false) {
                    try {
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL
                        const url = `${this.apiBaseUrl}${endpoint}`;

                        // –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                        const headers = {
                            'Content-Type': 'application/json',
                            ...options.headers
                        };

                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                        if (requireAuth && this.accessToken) {
                            headers['Authorization'] = `Bearer ${this.accessToken}`;
                        }

                        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
                        const response = await fetch(url, {
                            ...options,
                            headers
                        });

                        // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
                        const data = await response.json();

                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
                        if (!response.ok) {
                            throw new Error(JSON.stringify(data, null, 2));
                        }

                        this.response = data;
                        return data;

                    } catch (error) {
                        this.response = {
                            error: true,
                            message: error.message
                        };
                        console.error('API Error:', error);
                        throw error;
                    }
                },

                // ========== –ú–ï–¢–û–î–´ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ==========

                /**
                 * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                 * POST /user/register
                 */
                async registerUser() {
                    try {
                        const data = await this.apiRequest('/user/register', {
                            method: 'POST',
                            body: JSON.stringify(this.registerData)
                        });

                        alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');

                        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                        this.registerData = { username: '', email: '', password: '' };
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
                    }
                },

                /**
                 * –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                 * POST /user/token
                 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç access_token –∏ refresh_token
                 */
                async loginUser() {
                    try {
                        // FastAPI OAuth2 —Ç—Ä–µ–±—É–µ—Ç form-data, –∞ –Ω–µ JSON
                        const formData = new URLSearchParams();
                        formData.append('username', this.loginData.username);
                        formData.append('password', this.loginData.password);

                        const data = await this.apiRequest('/user/token', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: formData.toString()
                        });

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω—ã
                        this.accessToken = data.access_token;
                        this.refreshTokenValue = data.refresh_token;
                        this.userEmail = this.loginData.username;

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
                        localStorage.setItem('accessToken', data.access_token);
                        localStorage.setItem('refreshToken', data.refresh_token);
                        localStorage.setItem('userEmail', this.loginData.username);

                        alert('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                        this.getUserBase();
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                    }
                },

                /**
                 * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access_token —Å –ø–æ–º–æ—â—å—é refresh_token
                 * POST /user/refresh-token
                 */
                async refreshToken() {
                    try {
                        const data = await this.apiRequest(
                            `/user/refresh-token?refresh_token=${this.refreshTokenValue}`,
                            { method: 'POST' }
                        );

                        this.accessToken = data.access_token;
                        localStorage.setItem('accessToken', data.access_token);

                        alert('‚úÖ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + error.message);
                    }
                },

                /**
                 * –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                 * –û—á–∏—â–∞–µ—Ç –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –∏ –¥–∞–Ω–Ω—ã–µ
                 */
                logout() {
                    this.accessToken = null;
                    this.refreshTokenValue = null;
                    this.userEmail = null;
                    this.userInfo = null;

                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('userEmail');

                    alert('‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                },

                // ========== –ú–ï–¢–û–î–´ –†–ê–ë–û–¢–´ –° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ú ==========

                /**
                 * –ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                 * GET /user/
                 */
                async getUserBase() {
                    try {
                        const data = await this.apiRequest('/user/', {}, true);
                        this.userInfo = data;
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: ' + error.message);
                    }
                },

                /**
                 * –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                 * GET /user/info
                 */
                async getUserFull() {
                    try {
                        const data = await this.apiRequest('/user/info', {}, true);
                        this.userInfo = data;

                        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                        this.updateProfile = {
                            first_name: data.first_name || '',
                            last_name: data.last_name || '',
                            bio: data.bio || '',
                            phone_number: data.phone_number || '',
                            preferred_language: data.preferred_language || 'ru',
                            timezone: data.timezone || 'Europe/Moscow'
                        };
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: ' + error.message);
                    }
                },

                /**
                 * –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                 * PUT /user/update
                 */
                async updateUserProfile() {
                    try {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è
                        const dataToUpdate = {};
                        for (let key in this.updateProfile) {
                            if (this.updateProfile[key] !== '') {
                                dataToUpdate[key] = this.updateProfile[key];
                            }
                        }

                        const data = await this.apiRequest('/user/update', {
                            method: 'PUT',
                            body: JSON.stringify(dataToUpdate)
                        }, true);

                        this.userInfo = data;
                        alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!');
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
                    }
                },

                // ========== –ú–ï–¢–û–î–´ –†–ê–ë–û–¢–´ –° –ë–ï–°–ï–î–ê–ú–ò ==========

                /**
                 * –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –±–µ—Å–µ–¥—É
                 * POST /conversations/
                 */
                async createConversation() {
                    try {
                        const conversationData = {
                            title: this.conversationTitle || null
                        };

                        const data = await this.apiRequest('/conversations/', {
                            method: 'POST',
                            body: JSON.stringify(conversationData)
                        }, true);

                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—É—é –±–µ—Å–µ–¥—É –≤ —Å–ø–∏—Å–æ–∫
                        this.conversations.push(data);
                        this.selectConversation(data);

                        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
                        this.conversationTitle = '';

                        alert('‚úÖ –ë–µ—Å–µ–¥–∞ —Å–æ–∑–¥–∞–Ω–∞!');
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–µ—Å–µ–¥—ã: ' + error.message);
                    }
                },

                /**
                 * –í—ã–±—Ä–∞—Ç—å –±–µ—Å–µ–¥—É
                 */
                selectConversation(conversation) {
                    this.selectedConversation = conversation;
                    this.loadMessages();
                },

                /**
                 * –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–µ—Å–µ–¥—ã
                 * GET /conversations/{conversation_id}/messages
                 */
                async loadMessages() {
                    if (!this.selectedConversation) {
                        alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–µ—Å–µ–¥—É');
                        return;
                    }

                    try {
                        const data = await this.apiRequest(
                            `/conversations/${this.selectedConversation.id}/messages`,
                            {},
                            true
                        );

                        this.messages = data;
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + error.message);
                    }
                },

                /**
                 * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –±–µ—Å–µ–¥—É
                 * POST /conversations/{conversation_id}/messages
                 */
                async sendMessage() {
                    if (!this.selectedConversation) {
                        alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–µ—Å–µ–¥—É');
                        return;
                    }

                    if (!this.messageData.content.trim()) {
                        alert('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                        return;
                    }

                    try {
                        const messageData = {
                            role: this.messageData.role,
                            content: this.messageData.content
                        };

                        await this.apiRequest(
                            `/conversations/${this.selectedConversation.id}/messages`,
                            {
                                method: 'POST',
                                body: JSON.stringify(messageData)
                            },
                            true
                        );

                        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                        this.messageData.content = '';

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
                        this.loadMessages();
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                    }
                },

                // ========== –ú–ï–¢–û–î–´ –†–ê–ë–û–¢–´ –° POLYGON ==========

                /**
                 * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Polygon Chat
                 * POST /polygon/chat
                 */
                async sendPolygonMessage() {
                    if (!this.polygonMessage.trim()) {
                        alert('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiBaseUrl}/polygon/chat?message=${encodeURIComponent(this.polygonMessage)}`, {
                            method: 'POST'
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(JSON.stringify(data, null, 2));
                        }

                        this.response = data;
                        alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                    } catch (error) {
                        this.response = {
                            error: true,
                            message: error.message
                        };
                        alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                    }
                },

                // ========== –ú–ï–¢–û–î–´ –†–ê–ë–û–¢–´ –° MARKDOWN ==========

                /**
                 * –†–µ–Ω–¥–µ—Ä–∏—Ç Markdown-–∫–æ–Ω—Ç–µ–Ω—Ç –≤ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π HTML
                 * @param {string} content - Markdown —Ç–µ–∫—Å—Ç
                 * @returns {string} - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π HTML
                 */
                renderMarkdown(content) {
                    if (!content) return '';

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è Marked.js
                    marked.setOptions({
                        breaks: true, // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å —Ä–∞–∑—Ä—ã–≤—ã —Å—Ç—Ä–æ–∫ –≤ —Ç–µ–≥–∏ <br>
                        gfm: true,    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GitHub Flavored Markdown
                        sanitize: false, // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –æ—á–∏—Å—Ç–∫—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º DOMPurify
                        smartypants: true
                    });

                    // –†–µ–Ω–¥–µ—Ä–∏–º Markdown –≤ HTML
                    const renderedHtml = marked.parse(content);

                    // –û—á–∏—â–∞–µ–º HTML –æ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö —Ç–µ–≥–æ–≤ –∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
                    const safeHtml = DOMPurify.sanitize(renderedHtml);

                    return safeHtml;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
